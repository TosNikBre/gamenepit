{% extends 'base.html' %}

{% block title %}–°–Ω–æ—Å –∑–¥–∞–Ω–∏—è - –û—Å—Ç—Ä–æ–≤{% endblock %}

{% block extra_css %}
<style>
    .building-card {
        transition: all 0.3s;
        cursor: pointer;
        border: 2px solid transparent;
        height: 100%;
    }
    .building-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }
    .building-card.selected {
        border-color: #dc3545;
        background-color: #fff5f5;
    }
    .building-card.business {
        border-left: 4px solid #28a745;
    }
    .building-card.factory {
        border-left: 4px solid #007bff;
    }
    .building-card.house {
        border-left: 4px solid #ffc107;
    }
    .building-icon {
        font-size: 48px;
        margin-bottom: 15px;
    }
    .warning-icon {
        font-size: 72px;
        color: #dc3545;
        margin-bottom: 20px;
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }
    .profit-amount {
        font-size: 2rem;
        font-weight: bold;
        color: #28a745;
    }
    .demolition-cost {
        font-size: 1.5rem;
        font-weight: bold;
        color: #dc3545;
    }
    .compensation-box {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        margin-bottom: 20px;
    }
    .warning-box {
        background: linear-gradient(135deg, #dc3545, #c82333);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        margin-bottom: 20px;
    }
    .info-row {
        display: flex;
        justify-content: space-between;
        padding: 10px;
        border-bottom: 1px solid #dee2e6;
    }
    .info-row:last-child {
        border-bottom: none;
    }
    .info-label {
        font-weight: 600;
        color: #6c757d;
    }
    .info-value {
        font-size: 1.1rem;
    }
    .confirm-checkbox {
        transform: scale(1.5);
        margin-right: 10px;
    }
    .confirm-label {
        font-size: 1.1rem;
        color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="bi bi-building-slash"></i> –°–Ω–æ—Å –∑–¥–∞–Ω–∏—è</h2>
            <div>
        
                <a href="{% url 'island_dashboard' %}" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥
                </a>
            </div>
        </div>
        <p class="text-muted">–î–µ–º–æ–Ω—Ç–∞–∂ –ø–æ—Å—Ç—Ä–æ–µ–∫ –∏ –≤–æ–∑–≤—Ä–∞—Ç —Ä–µ—Å—É—Ä—Å–æ–≤</p>
    </div>

    {% if not buildings %}
    <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle"></i>
        –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–¥–∞–Ω–∏–π –¥–ª—è —Å–Ω–æ—Å–∞. 
        <br>–°–Ω–∞—á–∞–ª–∞ –ø–æ—Å—Ç—Ä–æ–π—Ç–µ –∑–¥–∞–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ <a href="{% url 'island_build' %}" class="alert-link">–ø–æ—Å—Ç—Ä–æ–π–∫–∏ –∑–¥–∞–Ω–∏–π</a>.
    </div>
    {% endif %}

    <div class="row">
        <!-- –§–æ—Ä–º–∞ —Å–Ω–æ—Å–∞ -->
        <div class="col-md-7 mb-4">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="bi bi-hammer"></i> –î–µ–º–æ–Ω—Ç–∞–∂ –∑–¥–∞–Ω–∏—è</h5>
                </div>
                <div class="card-body">
                    <form method="post" id="demolishForm" novalidate>
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {% for error in form.non_field_errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}

                        <!-- –í—ã–±–æ—Ä –∑–¥–∞–Ω–∏—è -->
                        <div class="mb-4">
                            <label for="{{ form.building.id_for_label }}" class="form-label fw-bold">
                                {{ form.building.label }} <span class="text-danger">*</span>
                            </label>
                            <select name="{{ form.building.name }}"
                                    id="{{ form.building.id_for_label }}"
                                    class="form-control form-control-lg {% if form.building.errors %}is-invalid{% endif %}"
                                    {% if not buildings %}disabled{% endif %}
                                    required>
                                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ –¥–ª—è —Å–Ω–æ—Å–∞ --</option>
                                {% for building in buildings %}
                                    <option value="{{ building.id }}" 
                                            data-owner="{{ building.owner_id }}"
                                            data-name="{{ building.building_name }}"
                                            data-type="{{ building.building_type }}"
                                            data-cost="{{ building.cost }}"
                                            data-income="{{ building.income_per_minute }}"
                                            data-last="{{ building.last_profit_collected|date:'U' }}"
                                            {% if form.building.value|stringformat:"s" == building.id|stringformat:"s" %}selected{% endif %}>
                                        #{{ building.owner_id }} - {{ building.building_name }} 
                                        ({{ building.get_building_type_display }}) - {{ building.cost }} ‚ÇΩ
                                    </option>
                                {% empty %}
                                    <option value="" disabled>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–¥–∞–Ω–∏–π</option>
                                {% endfor %}
                            </select>
                            {% if form.building.errors %}
                                <div class="invalid-feedback">
                                    {{ form.building.errors.0 }}
                                </div>
                            {% endif %}
                        </div>

                        <!-- –ù–æ–º–µ—Ä –∏–≥—Ä–æ–∫–∞ (–∫—Ç–æ —Å–Ω–æ—Å–∏—Ç) -->
                        <div class="mb-4">
                            <label for="{{ form.demolisher_id.id_for_label }}" class="form-label fw-bold">
                                {{ form.demolisher_id.label }} <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">#</span>
                                <input type="text" 
                                       name="{{ form.demolisher_id.name }}"
                                       id="{{ form.demolisher_id.id_for_label }}"
                                       class="form-control form-control-lg {% if form.demolisher_id.errors %}is-invalid{% endif %}"
                                       value="{{ form.demolisher_id.value|default:'' }}"
                                       placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∏–≥—Ä–æ–∫–∞ (–∫—Ç–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç —Å–Ω–æ—Å)"
                                       {% if not buildings %}disabled{% endif %}
                                       required>
                                <button class="btn btn-outline-secondary" type="button" id="checkDemolisherBtn">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                            {% if form.demolisher_id.errors %}
                                <div class="invalid-feedback">
                                    {{ form.demolisher_id.errors.0 }}
                                </div>
                            {% endif %}
                            <div class="form-text" id="demolisherInfo"></div>
                        </div>

                        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–¥–∞–Ω–∏–∏ -->
                        <div class="card mb-4" id="buildingInfo" style="display: none;">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0"><i class="bi bi-info-circle"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–¥–∞–Ω–∏–∏</h5>
                            </div>
                            <div class="card-body">
                                <div class="info-row">
                                    <span class="info-label">–í–ª–∞–¥–µ–ª–µ—Ü:</span>
                                    <span class="info-value" id="infoOwner">‚Äî</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">–ù–∞–∑–≤–∞–Ω–∏–µ:</span>
                                    <span class="info-value" id="infoName">‚Äî</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">–¢–∏–ø:</span>
                                    <span class="info-value" id="infoType">‚Äî</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ—Å—Ç—Ä–æ–π–∫–∏:</span>
                                    <span class="info-value" id="infoCost">0 ‚ÇΩ</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">–î–∞—Ç–∞ –ø–æ—Å—Ç—Ä–æ–π–∫–∏:</span>
                                    <span class="info-value" id="infoDate">‚Äî</span>
                                </div>
                            </div>
                        </div>

                        <!-- –î–ª—è –±–∏–∑–Ω–µ—Å–æ–≤ - –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–∞—è –ø—Ä–∏–±—ã–ª—å -->
                        <div class="card mb-4" id="businessProfit" style="display: none;">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0"><i class="bi bi-cash-stack"></i> –ù–∞–∫–æ–ø–ª–µ–Ω–Ω–∞—è –ø—Ä–∏–±—ã–ª—å</h5>
                            </div>
                            <div class="card-body">
                                <div class="compensation-box">
                                    <div class="warning-icon mb-3">üí∞</div>
                                    <h4>–ü—Ä–∏–±—ã–ª—å –∫ –≤—ã–¥–∞—á–µ</h4>
                                    <div class="profit-amount" id="accumulatedProfit">0 ‚ÇΩ</div>
                                    <p class="mt-3 mb-0">
                                        <small>–≠—Ç—É —Å—É–º–º—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–µ—Ä–µ–¥–∞—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü—É –ø—Ä–∏ —Å–Ω–æ—Å–µ</small>
                                    </p>
                                </div>
                                
                                <div class="info-row">
                                    <span class="info-label">–î–æ—Ö–æ–¥ –≤ –º–∏–Ω—É—Ç—É:</span>
                                    <span class="info-value" id="infoIncome">0 ‚ÇΩ/–º–∏–Ω</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:</span>
                                    <span class="info-value" id="workTime">0 –º–∏–Ω</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">–ü–æ—Å–ª–µ–¥–Ω–∏–π —Å–±–æ—Ä:</span>
                                    <span class="info-value" id="infoLast">‚Äî</span>
                                </div>
                            </div>
                        </div>

                        <!-- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ -->
                        <div class="warning-box mb-4" id="warningBox">
                            <i class="bi bi-exclamation-triangle-fill fs-1"></i>
                            <h4 class="mt-3">–í–Ω–∏–º–∞–Ω–∏–µ! –û–ø–µ—Ä–∞—Ü–∏—è –Ω–µ–æ–±—Ä–∞—Ç–∏–º–∞</h4>
                            <p>–ó–¥–∞–Ω–∏–µ –±—É–¥–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω–æ. –í–ª–∞–¥–µ–ª–µ—Ü –ø–æ—Ç–µ—Ä—è–µ—Ç –≤—Å–µ –≤–ª–æ–∂–µ–Ω–∏—è.</p>
                        </div>

                        <!-- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ -->
                        <div class="mb-4">
                            <div class="form-check">
                                <input class="form-check-input confirm-checkbox" type="checkbox" id="confirmCheck">
                                <label class="form-check-label confirm-label" for="confirmCheck">
                                    –Ø –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é, —á—Ç–æ —Ö–æ—á—É —Å–Ω–µ—Å—Ç–∏ —ç—Ç–æ –∑–¥–∞–Ω–∏–µ
                                </label>
                            </div>
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∏ -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{% url 'island_dashboard' %}" class="btn btn-secondary btn-lg me-md-2">
                                <i class="bi bi-x-circle"></i> –û—Ç–º–µ–Ω–∞
                            </a>
                            <button type="submit" class="btn btn-danger btn-lg" id="submitBtn" disabled>
                                <i class="bi bi-building-slash"></i> –°–Ω–µ—Å—Ç–∏ –∑–¥–∞–Ω–∏–µ
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="col-md-5 mb-4">
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–Ω–æ—Å–æ–≤ -->
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="bi bi-bar-chart"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–Ω–æ—Å–æ–≤</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6 text-center mb-3">
                            <h3>{{ total_demolitions|default:'0' }}</h3>
                            <small class="text-muted">–í—Å–µ–≥–æ —Å–Ω–æ—Å–æ–≤</small>
                        </div>
                        <div class="col-6 text-center mb-3">
                            <h3>{{ demolitions_today|default:'0' }}</h3>
                            <small class="text-muted">–ó–∞ —Å–µ–≥–æ–¥–Ω—è</small>
                        </div>
                        <div class="col-6 text-center">
                            <h3>{{ total_business_demolitions|default:'0' }}</h3>
                            <small class="text-muted">–ë–∏–∑–Ω–µ—Å–æ–≤ —Å–Ω–µ—Å–µ–Ω–æ</small>
                        </div>
                        <div class="col-6 text-center">
                            <h3>{{ total_compensation|default:'0' }} ‚ÇΩ</h3>
                            <small class="text-muted">–í—ã–ø–ª–∞—á–µ–Ω–æ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–π</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ü—Ä–∞–≤–∏–ª–∞ —Å–Ω–æ—Å–∞ -->
            <div class="card mb-4">
                <div class="card-header bg-warning">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> –ü—Ä–∞–≤–∏–ª–∞ —Å–Ω–æ—Å–∞</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li class="mb-3">
                            <i class="bi bi-1-circle-fill text-primary me-2"></i>
                            <strong>–ó–¥–∞–Ω–∏–µ —É–¥–∞–ª—è–µ—Ç—Å—è –Ω–∞–≤—Å–µ–≥–¥–∞</strong> - –æ–ø–µ—Ä–∞—Ü–∏—è –Ω–µ–æ–±—Ä–∞—Ç–∏–º–∞
                        </li>
                        <li class="mb-3">
                            <i class="bi bi-2-circle-fill text-primary me-2"></i>
                            <strong>–î–ª—è –±–∏–∑–Ω–µ—Å–æ–≤</strong> - –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–∞—è –ø—Ä–∏–±—ã–ª—å –≤—ã–ø–ª–∞—á–∏–≤–∞–µ—Ç—Å—è –≤–ª–∞–¥–µ–ª—å—Ü—É
                        </li>
                        <li class="mb-3">
                            <i class="bi bi-3-circle-fill text-primary me-2"></i>
                            <strong>–î–ª—è —Ñ–∞–±—Ä–∏–∫</strong> - –æ—Å—Ç–∞—Ç–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ —Ç–µ—Ä—è—é—Ç—Å—è
                        </li>
                        <li class="mb-3">
                            <i class="bi bi-4-circle-fill text-primary me-2"></i>
                            <strong>–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ—Å—Ç—Ä–æ–π–∫–∏</strong> –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è
                        </li>
                    </ul>
                </div>
            </div>

            <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–Ω–æ—Å—ã -->
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="bi bi-clock-history"></i> –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–Ω–æ—Å—ã</h5>
                </div>
                <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                    {% for demolition in recent_demolitions|slice:":10" %}
                    <div class="border-bottom mb-2 pb-2">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>{{ demolition.building_name }}</strong>
                                <br><small class="text-muted">–í–ª–∞–¥–µ–ª–µ—Ü #{{ demolition.owner_id }}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-danger">–°–Ω–µ—Å</span>
                                <br><small class="text-muted">{{ demolition.timestamp|time:"H:i" }}</small>
                            </div>
                        </div>
                        {% if demolition.accumulated_profit > 0 %}
                        <div class="mt-1">
                            <small class="text-success">–í—ã–ø–ª–∞—á–µ–Ω–æ: {{ demolition.accumulated_profit }} ‚ÇΩ</small>
                        </div>
                        {% endif %}
                    </div>
                    {% empty %}
                    <p class="text-muted text-center mb-0">–ù–µ—Ç —Å–Ω–æ—Å–æ–≤</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // –≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã
    const buildingSelect = document.getElementById('{{ form.building.id_for_label }}');
    const demolisherInput = document.getElementById('{{ form.demolisher_id.id_for_label }}');
    const confirmCheck = document.getElementById('confirmCheck');
    const submitBtn = document.getElementById('submitBtn');
    
    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
    const buildingInfo = document.getElementById('buildingInfo');
    const businessProfit = document.getElementById('businessProfit');
    const infoOwner = document.getElementById('infoOwner');
    const infoName = document.getElementById('infoName');
    const infoType = document.getElementById('infoType');
    const infoCost = document.getElementById('infoCost');
    const infoDate = document.getElementById('infoDate');
    const infoIncome = document.getElementById('infoIncome');
    const infoLast = document.getElementById('infoLast');
    const workTime = document.getElementById('workTime');
    const accumulatedProfit = document.getElementById('accumulatedProfit');
    const demolisherInfo = document.getElementById('demolisherInfo');

    let currentBuilding = null;
    let timerInterval = null;
    let lastTimestamp = null;

    // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const hours = Math.floor(mins / 60);
        const remainingMins = mins % 60;
        
        if (hours > 0) {
            return `${hours} —á ${remainingMins} –º–∏–Ω`;
        } else {
            return `${mins} –º–∏–Ω ${Math.floor(seconds % 60)} —Å–µ–∫`;
        }
    }

    // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã
    function formatDateTime(timestamp) {
        if (!timestamp) return '‚Äî';
        const date = new Date(timestamp * 1000);
        return date.toLocaleString('ru-RU', {
            hour: '2-digit',
            minute: '2-digit',
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞
    function updateTimer() {
        if (!lastTimestamp || !currentBuilding || currentBuilding.type !== 'business') return;
        
        const now = Math.floor(Date.now() / 1000);
        const diffSeconds = now - lastTimestamp;
        const diffMinutes = diffSeconds / 60;
        
        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—É—é –ø—Ä–∏–±—ã–ª—å
        const incomePerMinute = currentBuilding.income;
        const profit = incomePerMinute * diffMinutes;
        
        workTime.textContent = formatTime(diffSeconds);
        accumulatedProfit.textContent = profit.toFixed(2) + ' ‚ÇΩ';
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–¥–∞–Ω–∏–∏
    function loadBuildingInfo() {
        const selected = buildingSelect.options[buildingSelect.selectedIndex];
        
        if (selected && selected.value) {
            const lastTimestamp = parseInt(selected.dataset.last) || Math.floor(Date.now() / 1000) - 3600;
            
            currentBuilding = {
                id: selected.value,
                owner: selected.dataset.owner,
                name: selected.dataset.name,
                type: selected.dataset.type,
                cost: parseFloat(selected.dataset.cost),
                income: parseFloat(selected.dataset.income) || 0,
                last: lastTimestamp
            };
            
            // –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–¥–∞–Ω–∏–∏
            buildingInfo.style.display = 'block';
            infoOwner.textContent = '#' + currentBuilding.owner;
            infoName.textContent = currentBuilding.name;
            
            // –¢–∏–ø –∑–¥–∞–Ω–∏—è
            const typeMap = {
                'business': '–ë–∏–∑–Ω–µ—Å',
                'factory': '–§–∞–±—Ä–∏–∫–∞',
                'residential': '–ñ–∏–ª–æ–π –¥–æ–º',
                'other': '–î—Ä—É–≥–æ–µ'
            };
            infoType.textContent = typeMap[currentBuilding.type] || currentBuilding.type;
            
            infoCost.textContent = currentBuilding.cost.toFixed(2) + ' ‚ÇΩ';
            infoDate.textContent = formatDateTime(currentBuilding.last - 86400); // –ü—Ä–∏–º–µ—Ä: –¥–µ–Ω—å –Ω–∞–∑–∞–¥
            
            // –î–ª—è –±–∏–∑–Ω–µ—Å–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            if (currentBuilding.type === 'business') {
                businessProfit.style.display = 'block';
                infoIncome.textContent = currentBuilding.income.toFixed(2) + ' ‚ÇΩ/–º–∏–Ω';
                infoLast.textContent = formatDateTime(currentBuilding.last);
                
                lastTimestamp = currentBuilding.last;
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
                if (timerInterval) clearInterval(timerInterval);
                updateTimer();
                timerInterval = setInterval(updateTimer, 1000);
            } else {
                businessProfit.style.display = 'none';
                if (timerInterval) clearInterval(timerInterval);
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–Ω–æ—Å–∞
            checkSubmitPossibility();
        } else {
            buildingInfo.style.display = 'none';
            businessProfit.style.display = 'none';
            if (timerInterval) clearInterval(timerInterval);
            checkSubmitPossibility();
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è —Å–Ω–æ—Å–∞
    function checkDemolisher() {
        const demolisherId = demolisherInput.value.trim();
        
        if (demolisherId) {
            demolisherInfo.innerHTML = `<span class="text-success">‚úì –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å #${demolisherId} –Ω–∞–π–¥–µ–Ω</span>`;
        } else {
            demolisherInfo.innerHTML = '';
        }
        
        checkSubmitPossibility();
    }

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å–Ω–æ—Å–∞
    function checkSubmitPossibility() {
        const hasBuilding = buildingSelect.value !== '';
        const hasDemolisher = demolisherInput.value.trim() !== '';
        const isConfirmed = confirmCheck.checked;
        
        submitBtn.disabled = !(hasBuilding && hasDemolisher && isConfirmed);
    }

    // –°–æ–±—ã—Ç–∏—è
    buildingSelect.addEventListener('change', loadBuildingInfo);
    demolisherInput.addEventListener('input', checkDemolisher);
    demolisherInput.addEventListener('blur', checkDemolisher);
    confirmCheck.addEventListener('change', checkSubmitPossibility);
    
    document.getElementById('checkDemolisherBtn').addEventListener('click', checkDemolisher);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    if (buildingSelect.value) {
        loadBuildingInfo();
    }
    if (demolisherInput.value) {
        checkDemolisher();
    }
});
</script>
{% endblock %}