{% extends 'base.html' %}

{% block title %}–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–∞ - –û—Å—Ç—Ä–æ–≤{% endblock %}

{% block extra_css %}
<style>
    .factory-card {
        transition: all 0.3s;
        cursor: pointer;
        border: 2px solid transparent;
        height: 100%;
    }
    .factory-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }
    .factory-card.selected {
        border-color: #007bff;
        background-color: #f0f7ff;
    }
    .factory-icon {
        font-size: 48px;
        margin-bottom: 15px;
    }
    .processing-animation {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin: 20px 0;
    }
    .processing-animation .arrow {
        font-size: 24px;
        color: #28a745;
        animation: moveArrow 1s infinite;
    }
    @keyframes moveArrow {
        0% { transform: translateX(0); opacity: 1; }
        50% { transform: translateX(10px); opacity: 0.7; }
        100% { transform: translateX(0); opacity: 1; }
    }
    .resource-icon {
        width: 60px;
        height: 60px;
        background: #f8f9fa;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 30px;
        margin: 0 auto;
    }
    .product-icon {
        width: 60px;
        height: 60px;
        background: #28a745;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 30px;
        margin: 0 auto;
    }
    .efficiency-bar {
        height: 8px;
        background: linear-gradient(90deg, #28a745, #ffc107, #dc3545);
        border-radius: 4px;
        transition: width 0.3s ease;
    }
    .stats-box {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        text-align: center;
    }
    .stats-number {
        font-size: 1.8rem;
        font-weight: bold;
        color: #007bff;
    }
    .product-badge {
        background: #28a745;
        color: white;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.9rem;
    }
    .resource-badge {
        background: #dc3545;
        color: white;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="bi bi-gear"></i> –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–∞</h2>
            <div>
              
                <a href="{% url 'island_dashboard' %}" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥
                </a>
            </div>
        </div>
        <p class="text-muted">–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –Ω–∞ —Ñ–∞–±—Ä–∏–∫–∞—Ö –æ—Å—Ç—Ä–æ–≤–∞</p>
    </div>

    {% if not factories %}
    <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle"></i>
        –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ–∞–±—Ä–∏–∫ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤.
        <br>–°–Ω–∞—á–∞–ª–∞ –ø–æ—Å—Ç—Ä–æ–π—Ç–µ —Ñ–∞–±—Ä–∏–∫—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ <a href="{% url 'island_build' %}" class="alert-link">–ø–æ—Å—Ç—Ä–æ–π–∫–∏ –∑–¥–∞–Ω–∏–π</a>.
    </div>
    {% endif %}

    <div class="row">
        <!-- –§–æ—Ä–º–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ -->
        <div class="col-md-7 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-gear"></i> –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤</h5>
                </div>
                <div class="card-body">
                    <form method="post" id="processForm" novalidate>
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {% for error in form.non_field_errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}

                        <!-- –í—ã–±–æ—Ä —Ñ–∞–±—Ä–∏–∫–∏ -->
                        <div class="mb-4">
                            <label for="{{ form.factory.id_for_label }}" class="form-label fw-bold">
                                {{ form.factory.label }} <span class="text-danger">*</span>
                            </label>
                            <select name="{{ form.factory.name }}"
                                    id="{{ form.factory.id_for_label }}"
                                    class="form-control form-control-lg {% if form.factory.errors %}is-invalid{% endif %}"
                                    {% if not factories %}disabled{% endif %}
                                    required>
                                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–±—Ä–∏–∫—É --</option>
                                {% for factory in factories %}
                                    <option value="{{ factory.id }}" 
                                            data-owner="{{ factory.owner_id }}"
                                            data-name="{{ factory.building_name }}"
                                            data-efficiency="100"
                                            data-resource-type="coffee"
                                            data-product-type="processed_coffee"
                                            {% if form.factory.value|stringformat:"s" == factory.id|stringformat:"s" %}selected{% endif %}>
                                        #{{ factory.owner_id }} - {{ factory.building_name }}
                                    </option>
                                {% empty %}
                                    <option value="" disabled>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ–∞–±—Ä–∏–∫</option>
                                {% endfor %}
                            </select>
                            {% if form.factory.errors %}
                                <div class="invalid-feedback">
                                    {{ form.factory.errors.0 }}
                                </div>
                            {% endif %}
                        </div>

                        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–±—Ä–∏–∫–µ -->
                        <div class="card bg-light mb-4" id="factoryInfo" style="display: none;">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–±—Ä–∏–∫–µ</h6>
                                        <table class="table table-sm">
                                            <tr>
                                                <td>–í–ª–∞–¥–µ–ª–µ—Ü:</td>
                                                <td><strong id="infoOwner">‚Äî</strong></td>
                                            </tr>
                                            <tr>
                                                <td>–ù–∞–∑–≤–∞–Ω–∏–µ:</td>
                                                <td><strong id="infoName">‚Äî</strong></td>
                                            </tr>
                                            <tr>
                                                <td>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:</td>
                                                <td>
                                                    <span id="infoEfficiency">100</span>%
                                                    <div class="progress mt-1">
                                                        <div class="progress-bar bg-success" id="efficiencyBar" style="width: 100%;"></div>
                                                    </div>
                                                </td>
                                            </tr>
                                        </table>
                                    </div>
                                    <div class="col-md-6 text-center">
                                        <div class="processing-animation">
                                            <div class="resource-icon">üåæ</div>
                                            <div class="arrow">‚Üí</div>
                                            <div class="product-icon">üì¶</div>
                                        </div>
                                        <p class="mb-0">–°—ã—Ä—å–µ ‚Üí –ü—Ä–æ–¥—É–∫—Ç</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- –í—ã–±–æ—Ä —Ä–µ—Å—É—Ä—Å–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ) -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">–¢–∏–ø —Ä–µ—Å—É—Ä—Å–∞</label>
                            <div class="row">
                                <div class="col-md-6 mb-2">
                                    <div class="card resource-card" onclick="selectResource('coffee')">
                                        <div class="card-body text-center">
                                            <div class="resource-icon mb-2">‚òï</div>
                                            <h6>–ö–æ—Ñ–µ–π–Ω—ã–µ –∑–µ—Ä–Ω–∞</h6>
                                            <small class="text-muted">–í—ã—Ö–æ–¥: –æ–±–∂–∞—Ä–µ–Ω–Ω—ã–π –∫–æ—Ñ–µ</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <div class="card resource-card" onclick="selectResource('cocoa')">
                                        <div class="card-body text-center">
                                            <div class="resource-icon mb-2">üç´</div>
                                            <h6>–ö–∞–∫–∞–æ –±–æ–±—ã</h6>
                                            <small class="text-muted">–í—ã—Ö–æ–¥: —à–æ–∫–æ–ª–∞–¥</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <div class="card resource-card" onclick="selectResource('tobacco')">
                                        <div class="card-body text-center">
                                            <div class="resource-icon mb-2">üö¨</div>
                                            <h6>–¢–∞–±–∞–∫</h6>
                                            <small class="text-muted">–í—ã—Ö–æ–¥: —Å–∏–≥–∞—Ä—ã</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <div class="card resource-card" onclick="selectResource('sugar_cane')">
                                        <div class="card-body text-center">
                                            <div class="resource-icon mb-2">üéã</div>
                                            <h6>–¢—Ä–æ—Å—Ç–Ω–∏–∫</h6>
                                            <small class="text-muted">–í—ã—Ö–æ–¥: —Å–∞—Ö–∞—Ä</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" name="resource_type" id="resourceType" value="">
                        </div>

                        <!-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ—Å—É—Ä—Å–∞ -->
                        <div class="mb-4">
                            <label for="{{ form.quantity.id_for_label }}" class="form-label fw-bold">
                                {{ form.quantity.label }} <span class="text-danger">*</span>
                            </label>
                            <input type="number" 
                                   name="{{ form.quantity.name }}"
                                   id="{{ form.quantity.id_for_label }}"
                                   class="form-control form-control-lg {% if form.quantity.errors %}is-invalid{% endif %}"
                                   value="{{ form.quantity.value|default:'1' }}"
                                   min="1"
                                   max="1000"
                                   step="1"
                                   {% if not factories %}disabled{% endif %}
                                   required>
                            {% if form.quantity.errors %}
                                <div class="invalid-feedback">
                                    {{ form.quantity.errors.0 }}
                                </div>
                            {% endif %}
                            <div class="form-text">–ú–∞–∫—Å–∏–º—É–º: 1000 –µ–¥–∏–Ω–∏—Ü –∑–∞ —Ä–∞–∑</div>
                        </div>

                        <!-- –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ -->
                        <div class="card mb-4">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0"><i class="bi bi-calculator"></i> –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4 text-center">
                                        <div class="stats-box">
                                            <div class="stats-number" id="quantity">0</div>
                                            <div class="text-muted">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 text-center">
                                        <div class="stats-box">
                                            <div class="stats-number" id="pricePerUnit">5</div>
                                            <div class="text-muted">‚ÇΩ –∑–∞ –µ–¥.</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 text-center">
                                        <div class="stats-box">
                                            <div class="stats-number text-success" id="totalCost">0</div>
                                            <div class="text-muted">–ò—Ç–æ–≥–æ ‚ÇΩ</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mt-3">
                                    <div class="d-flex justify-content-between">
                                        <span>–í—ã—Ö–æ–¥ –ø—Ä–æ–¥—É–∫—Ü–∏–∏:</span>
                                        <strong><span id="outputQuantity">0</span> –µ–¥.</strong>
                                    </div>
                                    <div class="progress mt-1">
                                        <div class="progress-bar bg-success" id="outputBar" style="width: 0%;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- –í–Ω–µ—Å–µ–Ω–æ –¥–µ–Ω–µ–≥ -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">–í–Ω–µ—Å–µ–Ω–æ –¥–µ–Ω–µ–≥ <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="number" 
                                       id="moneyInput"
                                       class="form-control form-control-lg"
                                       step="0.01"
                                       min="0"
                                       placeholder="0.00"
                                       required>
                                <span class="input-group-text">‚ÇΩ</span>
                            </div>
                        </div>

                        <!-- –ë–ª–æ–∫ —Å–¥–∞—á–∏ -->
                        <div class="card bg-success text-white mb-4" id="changeBlock" style="display: none;">
                            <div class="card-body">
                                <h5 class="mb-0">–°–¥–∞—á–∞: <span id="changeAmount">0.00</span> ‚ÇΩ</h5>
                            </div>
                        </div>

                        <!-- –ë–ª–æ–∫ –æ—à–∏–±–∫–∏ -->
                        <div class="alert alert-danger mb-4" id="errorBlock" style="display: none;">
                            <i class="bi bi-exclamation-triangle"></i> 
                            –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤! –¢—Ä–µ–±—É–µ—Ç—Å—è: <span id="requiredAmount">0.00</span> ‚ÇΩ
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∏ -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{% url 'island_dashboard' %}" class="btn btn-secondary btn-lg me-md-2">
                                <i class="bi bi-x-circle"></i> –û—Ç–º–µ–Ω–∞
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" {% if not factories %}disabled{% endif %}>
                                <i class="bi bi-gear"></i> –û–±—Ä–∞–±–æ—Ç–∞—Ç—å
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="col-md-5 mb-4">
            <!-- –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-box"></i> –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã</h5>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <span class="resource-badge me-2">‚òï</span>
                                –ö–æ—Ñ–µ–π–Ω—ã–µ –∑–µ—Ä–Ω–∞
                            </div>
                            <span class="badge bg-primary">1,200</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <span class="resource-badge me-2">üç´</span>
                                –ö–∞–∫–∞–æ –±–æ–±—ã
                            </div>
                            <span class="badge bg-primary">850</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <span class="resource-badge me-2">üö¨</span>
                                –¢–∞–±–∞–∫
                            </div>
                            <span class="badge bg-primary">600</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <span class="resource-badge me-2">üéã</span>
                                –¢—Ä–æ—Å—Ç–Ω–∏–∫
                            </div>
                            <span class="badge bg-primary">2,000</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏ -->
            <div class="card mb-4">
                <div class="card-header bg-warning">
                    <h5 class="mb-0"><i class="bi bi-arrow-repeat"></i> –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>–†–µ—Å—É—Ä—Å</th>
                                <th>–í—ã—Ö–æ–¥</th>
                                <th>–¶–µ–Ω–∞</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>–ö–æ—Ñ–µ–π–Ω—ã–µ –∑–µ—Ä–Ω–∞</td>
                                <td>0.8 –µ–¥.</td>
                                <td>5 ‚ÇΩ/–µ–¥</td>
                            </tr>
                            <tr>
                                <td>–ö–∞–∫–∞–æ –±–æ–±—ã</td>
                                <td>0.9 –µ–¥.</td>
                                <td>5 ‚ÇΩ/–µ–¥</td>
                            </tr>
                            <tr>
                                <td>–¢–∞–±–∞–∫</td>
                                <td>0.7 –µ–¥.</td>
                                <td>5 ‚ÇΩ/–µ–¥</td>
                            </tr>
                            <tr>
                                <td>–¢—Ä–æ—Å—Ç–Ω–∏–∫</td>
                                <td>0.6 –µ–¥.</td>
                                <td>5 ‚ÇΩ/–µ–¥</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ -->
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="bi bi-clock-history"></i> –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏</h5>
                </div>
                <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                    {% for process in recent_processes|slice:":10" %}
                    <div class="border-bottom mb-2 pb-2">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>–ò–≥—Ä–æ–∫ #{{ process.player_id }}</strong>
                                <br><small class="text-muted">{{ process.resource_type }}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-primary">{{ process.quantity }} —à—Ç</span>
                                <br><small class="text-muted">{{ process.timestamp|time:"H:i" }}</small>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted text-center mb-0">–ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–æ–∫</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // –≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã
    const factorySelect = document.getElementById('{{ form.factory.id_for_label }}');
    const quantityInput = document.getElementById('{{ form.quantity.id_for_label }}');
    const moneyInput = document.getElementById('moneyInput');
    const submitBtn = document.getElementById('submitBtn');
    const resourceInput = document.getElementById('resourceType');
    
    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
    const factoryInfo = document.getElementById('factoryInfo');
    const infoOwner = document.getElementById('infoOwner');
    const infoName = document.getElementById('infoName');
    const efficiencyBar = document.getElementById('efficiencyBar');
    const quantity = document.getElementById('quantity');
    const pricePerUnit = document.getElementById('pricePerUnit');
    const totalCost = document.getElementById('totalCost');
    const outputQuantity = document.getElementById('outputQuantity');
    const outputBar = document.getElementById('outputBar');
    const changeBlock = document.getElementById('changeBlock');
    const changeAmount = document.getElementById('changeAmount');
    const errorBlock = document.getElementById('errorBlock');
    const requiredAmount = document.getElementById('requiredAmount');

    // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
    const PROCESSING_COST = 5; // –¶–µ–Ω–∞ –∑–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ–¥–Ω–æ–π –µ–¥–∏–Ω–∏—Ü—ã
    const OUTPUT_RATIOS = {
        'coffee': 0.8,
        'cocoa': 0.9,
        'tobacco': 0.7,
        'sugar_cane': 0.6
    };

    let selectedResource = null;

    // –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ —Ä–µ—Å—É—Ä—Å–∞
    window.selectResource = function(resource) {
        selectedResource = resource;
        resourceInput.value = resource;
        
        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏
        document.querySelectorAll('.resource-card').forEach(card => {
            card.classList.remove('selected');
        });
        event.currentTarget.classList.add('selected');
        
        updateCalculation();
    };

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–∞–±—Ä–∏–∫–µ
    function loadFactoryInfo() {
        const selected = factorySelect.options[factorySelect.selectedIndex];
        
        if (selected && selected.value) {
            factoryInfo.style.display = 'block';
            infoOwner.textContent = '#' + selected.dataset.owner;
            infoName.textContent = selected.dataset.name;
            
            // –†–∞–Ω–¥–æ–º–Ω–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
            const efficiency = 85 + Math.floor(Math.random() * 15);
            document.getElementById('infoEfficiency').textContent = efficiency;
            efficiencyBar.style.width = efficiency + '%';
            efficiencyBar.className = efficiency > 90 ? 'progress-bar bg-success' : 
                                     efficiency > 75 ? 'progress-bar bg-warning' : 
                                     'progress-bar bg-danger';
        } else {
            factoryInfo.style.display = 'none';
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–∞—Å—á–µ—Ç–∞
    function updateCalculation() {
        const qty = parseInt(quantityInput.value) || 0;
        const ratio = selectedResource ? OUTPUT_RATIOS[selectedResource] || 0.8 : 0.8;
        const output = Math.floor(qty * ratio);
        
        quantity.textContent = qty;
        totalCost.textContent = (qty * PROCESSING_COST).toFixed(2);
        outputQuantity.textContent = output;
        
        const outputPercent = (output / qty) * 100;
        outputBar.style.width = outputPercent + '%';
        
        if (qty > 0) {
            checkFunds();
        } else {
            submitBtn.disabled = true;
            changeBlock.style.display = 'none';
            errorBlock.style.display = 'none';
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç–∏ —Å—Ä–µ–¥—Å—Ç–≤
    function checkFunds() {
        const qty = parseInt(quantityInput.value) || 0;
        const required = qty * PROCESSING_COST;
        const money = parseFloat(moneyInput.value) || 0;
        
        if (money >= required) {
            const change = money - required;
            changeAmount.textContent = change.toFixed(2);
            changeBlock.style.display = 'block';
            errorBlock.style.display = 'none';
            submitBtn.disabled = false;
        } else {
            changeBlock.style.display = 'none';
            errorBlock.style.display = 'block';
            requiredAmount.textContent = required.toFixed(2);
            submitBtn.disabled = true;
        }
    }

    // –°–æ–±—ã—Ç–∏—è
    factorySelect.addEventListener('change', loadFactoryInfo);
    quantityInput.addEventListener('input', updateCalculation);
    moneyInput.addEventListener('input', checkFunds);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    if (factorySelect.value) {
        loadFactoryInfo();
    }
    updateCalculation();

    // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏ —Ä–µ—Å—É—Ä—Å–∞
    const style = document.createElement('style');
    style.textContent = `
        .resource-card {
            transition: all 0.3s;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .resource-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .resource-card.selected {
            border-color: #007bff;
            background-color: #f0f7ff;
        }
    `;
    document.head.appendChild(style);
});
</script>
{% endblock %}