{% extends 'base.html' %}

{% block title %}–í–Ω–µ—Å–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ - –í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è{% endblock %}

{% block extra_css %}
<style>
    .debtor-card {
        transition: all 0.3s;
        cursor: pointer;
        border: 2px solid transparent;
    }
    .debtor-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }
    .debtor-card.selected {
        border-color: #28a745;
        background-color: #f0fff0;
    }
    .overdue-badge {
        background: #dc3545;
        color: white;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        animation: pulse 1s infinite;
    }
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }
    .payment-progress {
        height: 8px;
        border-radius: 4px;
    }
    .bonus-info {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 15px;
        border-radius: 10px;
    }
    .timer-large {
        font-size: 2rem;
        font-weight: bold;
        font-family: monospace;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="bi bi-cash"></i> –í–Ω–µ—Å–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞</h2>
            <div>
                <span class="badge bg-primary badge-custom me-2">
                    <i class="bi bi-person"></i> {{ session.username|default:'–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä' }}
                </span>
                <a href="{% url 'britain_credits' %}" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> –ö –∫—Ä–µ–¥–∏—Ç–∞–º
                </a>
            </div>
        </div>
        <p class="text-muted">–ü–æ–≥–∞—à–µ–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–∞ - –¥–æ—Å—Ä–æ—á–Ω–æ–µ –ø–æ–≥–∞—à–µ–Ω–∏–µ –ø–æ–æ—â—Ä—è–µ—Ç—Å—è</p>
    </div>

    <div class="row">
        <!-- –§–æ—Ä–º–∞ –ø–ª–∞—Ç–µ–∂–∞ -->
        <div class="col-md-8 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-cash-stack"></i> –í–Ω–µ—Å—Ç–∏ –ø–ª–∞—Ç–µ–∂</h5>
                </div>
                <div class="card-body">
                    <form method="post" id="paymentForm" novalidate>
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {% for error in form.non_field_errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}

                        <!-- –í—ã–±–æ—Ä –¥–æ–ª–∂–Ω–∏–∫–∞ -->
                        <div class="mb-4">
                            <label for="{{ form.debtor.id_for_label }}" class="form-label fw-bold">
                                {{ form.debtor.label }} <span class="text-danger">*</span>
                            </label>
                            <select name="{{ form.debtor.name }}"
                                    id="{{ form.debtor.id_for_label }}"
                                    class="form-control form-control-lg {% if form.debtor.errors %}is-invalid{% endif %}"
                                    required>
                                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–ª–∂–Ω–∏–∫–∞ --</option>
                                {% for debtor in form.fields.debtor.queryset %}
                                    <option value="{{ debtor.id }}" 
                                            data-player="{{ debtor.player_id }}"
                                            data-amount="{{ debtor.credit_amount }}"
                                            data-monthly="{{ debtor.monthly_payment }}"
                                            data-remaining="{{ debtor.remaining_payments }}"
                                            data-term="{{ debtor.term_months }}"
                                            data-overdue="{{ debtor.is_overdue|lower }}"
                                            {% if form.debtor.value|stringformat:"s" == debtor.id|stringformat:"s" %}selected{% endif %}>
                                        –ò–≥—Ä–æ–∫ #{{ debtor.player_id }} - {{ debtor.remaining_payments }}/{{ debtor.term_months }} –ø–ª–∞—Ç–µ–∂–µ–π
                                        ({{ debtor.credit_amount }} ‚ÇΩ)
                                        {% if debtor.is_overdue %}‚ö† –ü–†–û–°–†–û–ß–ö–ê{% endif %}
                                    </option>
                                {% empty %}
                                    <option value="" disabled>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫—Ä–µ–¥–∏—Ç–æ–≤</option>
                                {% endfor %}
                            </select>
                            {% if form.debtor.errors %}
                                <div class="invalid-feedback">
                                    {{ form.debtor.errors.0 }}
                                </div>
                            {% endif %}
                        </div>

                        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫—Ä–µ–¥–∏—Ç–µ -->
                        <div class="card bg-light mb-4" id="creditInfo" style="display: none;">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫—Ä–µ–¥–∏—Ç–µ</h6>
                                        <table class="table table-sm">
                                            <tr>
                                                <td>–ò–≥—Ä–æ–∫:</td>
                                                <td><strong id="infoPlayer">‚Äî</strong></td>
                                            </tr>
                                            <tr>
                                                <td>–°—É–º–º–∞ –∫—Ä–µ–¥–∏—Ç–∞:</td>
                                                <td><strong id="infoAmount">0 ‚ÇΩ</strong></td>
                                            </tr>
                                            <tr>
                                                <td>–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–ª–∞—Ç–µ–∂:</td>
                                                <td><strong id="infoMonthly">0 ‚ÇΩ</strong></td>
                                            </tr>
                                            <tr>
                                                <td>–û—Å—Ç–∞–ª–æ—Å—å –ø–ª–∞—Ç–µ–∂–µ–π:</td>
                                                <td><strong id="infoRemaining">0</strong></td>
                                            </tr>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>–ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–≥–∞—à–µ–Ω–∏—è</h6>
                                        <div class="progress payment-progress mb-3">
                                            <div class="progress-bar bg-success" id="paymentProgress" style="width: 0%;"></div>
                                        </div>
                                        <div id="overdueWarning" class="alert alert-danger" style="display: none;">
                                            <i class="bi bi-exclamation-triangle"></i>
                                            –ü—Ä–æ—Å—Ä–æ—á–∫–∞ –ø–ª–∞—Ç–µ–∂–∞!
                                        </div>
                                        <div id="timer" class="text-center" style="display: none;">
                                            <small>–í—Ä–µ–º—è —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–ª–∞—Ç–µ–∂–∞:</small>
                                            <div class="timer-large" id="timerDisplay">00:00:00</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- –°—É–º–º–∞ –≤–∑–Ω–æ—Å–∞ -->
                        <div class="mb-4">
                            <label for="{{ form.payment_amount.id_for_label }}" class="form-label fw-bold">
                                {{ form.payment_amount.label }} <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <input type="number" 
                                       name="{{ form.payment_amount.name }}"
                                       id="{{ form.payment_amount.id_for_label }}"
                                       class="form-control form-control-lg {% if form.payment_amount.errors %}is-invalid{% endif %}"
                                       value="{{ form.payment_amount.value|default:'' }}"
                                       step="0.01"
                                       min="0.01"
                                       placeholder="0.00"
                                       required>
                                <span class="input-group-text">‚ÇΩ</span>
                                {% if form.payment_amount.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.payment_amount.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø–æ–≥–∞—à–µ–Ω–∏—è -->
                        <div class="card mb-4" id="repaymentCalc" style="display: none;">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0">üìä –†–∞—Å—á–µ—Ç –ø–æ–≥–∞—à–µ–Ω–∏—è</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="alert alert-success">
                                            <small>–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–ª–∞—Ç–µ–∂:</small>
                                            <h4 id="requiredPayment">0 ‚ÇΩ</h4>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="alert alert-warning">
                                            <small>–ë–æ–Ω—É—Å –∑–∞ –ø–µ—Ä–µ–ø–ª–∞—Ç—É:</small>
                                            <h4 id="bonusInfo">0 ‚ÇΩ = 0 –º–µ—Å</h4>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bonus-info text-center">
                                    <i class="bi bi-star-fill"></i>
                                    –ó–∞ –∫–∞–∂–¥—ã–µ 0.66 √ó –ø–ª–∞—Ç–µ–∂ —Å–≤–µ—Ä—Ö –Ω–æ—Ä–º—ã —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è +1 –º–µ—Å—è—Ü
                                </div>
                                
                                <div class="mt-3" id="resultInfo">
                                    <table class="table">
                                        <tr>
                                            <td>–ë—É–¥–µ—Ç —Å–ø–∏—Å–∞–Ω–æ –ø–ª–∞—Ç–µ–∂–µ–π:</td>
                                            <td><strong id="paymentsCovered">0</strong></td>
                                        </tr>
                                        <tr>
                                            <td>–û—Å—Ç–∞—Ç–æ–∫ –ø–æ—Å–ª–µ –ø–ª–∞—Ç–µ–∂–∞:</td>
                                            <td><strong id="remainingAfter">0</strong></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∏ -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{% url 'britain_credits' %}" class="btn btn-secondary btn-lg me-md-2">
                                <i class="bi bi-x-circle"></i> –û—Ç–º–µ–Ω–∞
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" disabled>
                                <i class="bi bi-check-circle"></i> –í–Ω–µ—Å—Ç–∏ –ø–ª–∞—Ç–µ–∂
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="col-md-4 mb-4">
            <!-- –ü—Ä–∞–≤–∏–ª–∞ –ø–æ–≥–∞—à–µ–Ω–∏—è -->
            <div class="card mb-4">
                <div class="card-header bg-warning">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> –ü—Ä–∞–≤–∏–ª–∞ –ø–æ–≥–∞—à–µ–Ω–∏—è</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li class="mb-3">
                            <i class="bi bi-1-circle-fill text-primary me-2"></i>
                            <strong>–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–ª–∞—Ç–µ–∂:</strong> —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω
                        </li>
                        <li class="mb-3">
                            <i class="bi bi-2-circle-fill text-primary me-2"></i>
                            –ï—Å–ª–∏ —Å—É–º–º–∞ ‚â• –ø–ª–∞—Ç–µ–∂: —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è 1 –ø–ª–∞—Ç–µ–∂
                        </li>
                        <li class="mb-3">
                            <i class="bi bi-3-circle-fill text-primary me-2"></i>
                            –ó–∞ –∫–∞–∂–¥—ã–µ 0.66 √ó –ø–ª–∞—Ç–µ–∂ —Å–≤–µ—Ä—Ö –Ω–æ—Ä–º—ã: +1 –º–µ—Å—è—Ü
                        </li>
                        <li class="mb-3">
                            <i class="bi bi-4-circle-fill text-primary me-2"></i>
                            –ï—Å–ª–∏ –æ—Å—Ç–∞—Ç–æ–∫ = 0: –∫—Ä–µ–¥–∏—Ç –∑–∞–∫—Ä—ã—Ç
                        </li>
                    </ul>
                </div>
            </div>

            <!-- –ë—ã—Å—Ç—Ä—ã–µ —Å—É–º–º—ã -->
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="bi bi-lightning"></i> –ë—ã—Å—Ç—Ä—ã–µ —Å—É–º–º—ã</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" onclick="setPayment('required')">
                            –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–ª–∞—Ç–µ–∂
                        </button>
                        <button class="btn btn-outline-success" onclick="setPayment('double')">
                            –î–≤–æ–π–Ω–æ–π –ø–ª–∞—Ç–µ–∂
                        </button>
                        <button class="btn btn-outline-info" onclick="setPayment('triple')">
                            –¢—Ä–æ–π–Ω–æ–π –ø–ª–∞—Ç–µ–∂
                        </button>
                        <button class="btn btn-outline-warning" onclick="setPayment('full')">
                            –ü–æ–ª–Ω–æ–µ –ø–æ–≥–∞—à–µ–Ω–∏–µ
                        </button>
                    </div>
                </div>
            </div>

            <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∏ -->
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="bi bi-clock-history"></i> –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∏</h5>
                </div>
                <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                    {% for payment in recent_payments|slice:":10" %}
                    <div class="border-bottom mb-2 pb-2">
                        <div class="d-flex justify-content-between">
                            <span><strong>#{{ payment.player_id }}</strong></span>
                            <span class="badge bg-success">{{ payment.amount }} ‚ÇΩ</span>
                        </div>
                        <small class="text-muted">{{ payment.timestamp|date:"d.m.Y H:i" }}</small>
                    </div>
                    {% empty %}
                    <p class="text-muted text-center mb-0">–ù–µ—Ç –ø–ª–∞—Ç–µ–∂–µ–π</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // –≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã
    const debtorSelect = document.getElementById('{{ form.debtor.id_for_label }}');
    const paymentInput = document.getElementById('{{ form.payment_amount.id_for_label }}');
    const submitBtn = document.getElementById('submitBtn');
    
    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
    const creditInfo = document.getElementById('creditInfo');
    const repaymentCalc = document.getElementById('repaymentCalc');
    const infoPlayer = document.getElementById('infoPlayer');
    const infoAmount = document.getElementById('infoAmount');
    const infoMonthly = document.getElementById('infoMonthly');
    const infoRemaining = document.getElementById('infoRemaining');
    const paymentProgress = document.getElementById('paymentProgress');
    const overdueWarning = document.getElementById('overdueWarning');
    const timer = document.getElementById('timer');
    const timerDisplay = document.getElementById('timerDisplay');
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
    const requiredPayment = document.getElementById('requiredPayment');
    const bonusInfo = document.getElementById('bonusInfo');
    const paymentsCovered = document.getElementById('paymentsCovered');
    const remainingAfter = document.getElementById('remainingAfter');

    let currentDebtor = null;
    let timerInterval = null;

    // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
    function formatTime(seconds) {
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = seconds % 60;
        return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞
    function updateTimer(lastPayment) {
        if (timerInterval) clearInterval(timerInterval);
        
        timerInterval = setInterval(() => {
            const now = Math.floor(Date.now() / 1000);
            const diff = now - lastPayment;
            timerDisplay.textContent = formatTime(diff);
        }, 1000);
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫—Ä–µ–¥–∏—Ç–µ
    function loadCreditInfo() {
        const selected = debtorSelect.options[debtorSelect.selectedIndex];
        
        if (selected && selected.value) {
            currentDebtor = {
                id: selected.value,
                player: selected.dataset.player,
                amount: parseFloat(selected.dataset.amount),
                monthly: parseFloat(selected.dataset.monthly),
                remaining: parseInt(selected.dataset.remaining),
                term: parseInt(selected.dataset.term),
                overdue: selected.dataset.overdue === 'true'
            };
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            creditInfo.style.display = 'block';
            infoPlayer.textContent = '#' + currentDebtor.player;
            infoAmount.textContent = currentDebtor.amount.toFixed(2) + ' ‚ÇΩ';
            infoMonthly.textContent = currentDebtor.monthly.toFixed(2) + ' ‚ÇΩ';
            infoRemaining.textContent = currentDebtor.remaining + '/' + currentDebtor.term;
            
            // –ü—Ä–æ–≥—Ä–µ—Å—Å
            const progress = ((currentDebtor.term - currentDebtor.remaining) / currentDebtor.term) * 100;
            paymentProgress.style.width = progress + '%';
            
            // –ü—Ä–æ—Å—Ä–æ—á–∫–∞
            if (currentDebtor.overdue) {
                overdueWarning.style.display = 'block';
            } else {
                overdueWarning.style.display = 'none';
            }
            
            // –¢–∞–π–º–µ—Ä (–∑–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π timestamp)
            timer.style.display = 'block';
            updateTimer(Math.floor(Date.now() / 1000) - 300); // –ü—Ä–∏–º–µ—Ä: 5 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥
            
            updateCalculation();
        } else {
            creditInfo.style.display = 'none';
            repaymentCalc.style.display = 'none';
            submitBtn.disabled = true;
            if (timerInterval) clearInterval(timerInterval);
        }
    }

    // –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ –ø–æ–≥–∞—à–µ–Ω–∏—è
    function calculateRepayment(amount) {
        if (!currentDebtor) return null;
        
        const monthly = currentDebtor.monthly;
        let covered = 0;
        let remaining = amount;
        
        // –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–ª–∞—Ç–µ–∂
        if (remaining >= monthly) {
            covered++;
            remaining -= monthly;
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏
            const bonusThreshold = monthly * 0.66;
            while (remaining >= bonusThreshold && covered < currentDebtor.remaining) {
                covered++;
                remaining -= bonusThreshold;
            }
        }
        
        // –ù–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –ø–ª–∞—Ç–µ–∂–µ–π
        covered = Math.min(covered, currentDebtor.remaining);
        
        return {
            covered: covered,
            remainingAmount: remaining,
            newRemaining: currentDebtor.remaining - covered
        };
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
    function updateCalculation() {
        const payment = parseFloat(paymentInput.value) || 0;
        
        if (currentDebtor && payment > 0) {
            repaymentCalc.style.display = 'block';
            requiredPayment.textContent = currentDebtor.monthly.toFixed(2) + ' ‚ÇΩ';
            
            const result = calculateRepayment(payment);
            
            if (result) {
                const bonusMonths = result.covered - 1;
                const bonusAmount = bonusMonths > 0 ? bonusMonths * (currentDebtor.monthly * 0.66) : 0;
                
                bonusInfo.innerHTML = `${bonusAmount.toFixed(2)} ‚ÇΩ = +${bonusMonths} –º–µ—Å`;
                paymentsCovered.textContent = result.covered;
                remainingAfter.textContent = result.newRemaining;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
                if (payment >= currentDebtor.monthly) {
                    submitBtn.disabled = false;
                } else {
                    submitBtn.disabled = true;
                }
            }
        } else {
            repaymentCalc.style.display = 'none';
            submitBtn.disabled = true;
        }
    }

    // –§—É–Ω–∫—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –±—ã—Å—Ç—Ä–æ–π —Å—É–º–º—ã
    window.setPayment = function(type) {
        if (!currentDebtor) {
            alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–æ–ª–∂–Ω–∏–∫–∞');
            return;
        }
        
        let amount = 0;
        switch(type) {
            case 'required':
                amount = currentDebtor.monthly;
                break;
            case 'double':
                amount = currentDebtor.monthly * 2;
                break;
            case 'triple':
                amount = currentDebtor.monthly * 3;
                break;
            case 'full':
                amount = currentDebtor.amount;
                break;
        }
        
        paymentInput.value = amount.toFixed(2);
        updateCalculation();
    };

    // –°–æ–±—ã—Ç–∏—è
    debtorSelect.addEventListener('change', loadCreditInfo);
    paymentInput.addEventListener('input', updateCalculation);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    if (debtorSelect.value) {
        loadCreditInfo();
    }
});
</script>
{% endblock %}