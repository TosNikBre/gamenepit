{% extends 'base.html' %}

{% block title %}–°–¥–µ–ª–∫–∞ —Å –∫–æ—Ä–∞–±–ª–µ–º - –í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è{% endblock %}

{% block extra_css %}
<style>
    .ship-card {
        cursor: pointer;
        transition: all 0.3s;
        border: 2px solid transparent;
    }
    .ship-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }
    .ship-card.selected {
        border-color: #007bff;
        background-color: #f0f7ff;
    }
    .ship-icon {
        font-size: 48px;
        margin-bottom: 10px;
    }
    .deal-type-btn {
        padding: 15px;
        font-size: 1.2rem;
        transition: all 0.3s;
    }
    .deal-type-btn.active {
        transform: scale(1.02);
        box-shadow: 0 5px 15px rgba(0,123,255,0.3);
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="bi bi-ship"></i> –°–¥–µ–ª–∫–∞ —Å –∫–æ—Ä–∞–±–ª–µ–º</h2>
            <div>
                <span class="badge bg-primary badge-custom me-2">
                    <i class="bi bi-person"></i> {{ session.username|default:'–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä' }}
                </span>
                <a href="{% url 'britain_dashboard' %}" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥
                </a>
            </div>
        </div>
        <p class="text-muted">–í–µ—Ä—Ñ—å –í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏–∏ - –ø–æ–∫—É–ø–∫–∞ –∏ –ø—Ä–æ–¥–∞–∂–∞ –∫–æ—Ä–∞–±–ª–µ–π</p>
    </div>

    <div class="row">
        <!-- –§–æ—Ä–º–∞ —Å–¥–µ–ª–∫–∏ -->
        <div class="col-md-8 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-cart"></i> –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —Å–¥–µ–ª–∫–∏</h5>
                </div>
                <div class="card-body">
                    <form method="post" id="shipDealForm" novalidate>
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {% for error in form.non_field_errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}

                        <!-- –í—ã–±–æ—Ä –∫–æ—Ä–∞–±–ª—è (–≤–∏–∑—É–∞–ª—å–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏) -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä–∞–±–ª—å <span class="text-danger">*</span></label>
                            <div class="row" id="shipCards">
                                {% for value, label in form.fields.ship.choices %}
                                <div class="col-md-4 mb-3">
                                    <div class="card ship-card" data-ship="{{ value }}" onclick="selectShip('{{ value }}')">
                                        <div class="card-body text-center">
                                            <div class="ship-icon">
                                                {% if value == 'schooner' %}‚õµ
                                                {% elif value == 'brig' %}‚öì
                                                {% elif value == 'frigate' %}üö¢
                                                {% elif value == 'battleship' %}‚öîÔ∏è
                                                {% elif value == 'steam_frigate' %}üî•
                                                {% endif %}
                                            </div>
                                            <h6>{{ label }}</h6>
                                            <span class="badge bg-primary" id="price-{{ value }}">
                                                {% if value == 'schooner' %}500
                                                {% elif value == 'brig' %}1000
                                                {% elif value == 'frigate' %}2000
                                                {% elif value == 'battleship' %}5000
                                                {% elif value == 'steam_frigate' %}8000
                                                {% endif %} ‚ÇΩ
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <input type="hidden" name="{{ form.ship.name }}" id="{{ form.ship.id_for_label }}" value="{{ form.ship.value|default:'' }}">
                        </div>

                        <!-- –¢–∏–ø —Å–¥–µ–ª–∫–∏ -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">{{ form.deal_type.label }} <span class="text-danger">*</span></label>
                            <div class="row">
                                {% for radio in form.deal_type %}
                                <div class="col-md-6">
                                    <div class="card deal-type-btn {% if radio.data.value == 'buy' %}active{% endif %}" 
                                         onclick="selectDealType('{{ radio.data.value }}')">
                                        <div class="card-body text-center">
                                            {{ radio.tag }}
                                            <label for="{{ radio.id_for_label }}" class="w-100">
                                                {% if radio.data.value == 'buy' %}
                                                    <i class="bi bi-cart-plus fs-3"></i><br>
                                                    –ü–æ–∫—É–ø–∫–∞
                                                {% else %}
                                                    <i class="bi bi-cart-dash fs-3"></i><br>
                                                    –ü—Ä–æ–¥–∞–∂–∞
                                                {% endif %}
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- –ù–æ–º–µ—Ä –∏–≥—Ä–æ–∫–∞ -->
                        <div class="mb-4">
                            <label for="{{ form.player_id.id_for_label }}" class="form-label fw-bold">
                                {{ form.player_id.label }} <span class="text-danger">*</span>
                            </label>
                            <input type="text" 
                                   name="{{ form.player_id.name }}"
                                   id="{{ form.player_id.id_for_label }}"
                                   class="form-control form-control-lg {% if form.player_id.errors %}is-invalid{% endif %}"
                                   value="{{ form.player_id.value|default:'' }}"
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∏–≥—Ä–æ–∫–∞"
                                   required>
                            {% if form.player_id.errors %}
                                <div class="invalid-feedback">
                                    {{ form.player_id.errors.0 }}
                                </div>
                            {% endif %}
                        </div>

                        <!-- –°—É–º–º–∞ —Å–¥–µ–ª–∫–∏ -->
                        <div class="card bg-light mb-4">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>–¶–µ–Ω–∞ –∫–æ—Ä–∞–±–ª—è:</h6>
                                        <span class="display-6" id="shipPrice">0</span> ‚ÇΩ
                                    </div>
                                    <div class="col-md-6">
                                        <h6>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</h6>
                                        <span class="display-6 text-primary" id="totalPrice">0</span> ‚ÇΩ
                                    </div>
                                </div>
                                <div id="sellInfo" class="alert alert-info mt-3" style="display: none;">
                                    <i class="bi bi-info-circle"></i> –ü—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ –∫–æ—Ä–∞–±–ª—è –≤—ã–ø–ª–∞—á–∏–≤–∞–µ—Ç—Å—è 50% –æ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏
                                </div>
                            </div>
                        </div>

                        <!-- –í–Ω–µ—Å–µ–Ω–æ –¥–µ–Ω–µ–≥ (—Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–∫—É–ø–∫–∏) -->
                        <div class="mb-4" id="moneyInputBlock">
                            <label for="{{ form.money_input.id_for_label }}" class="form-label fw-bold">
                                {{ form.money_input.label }}
                            </label>
                            <div class="input-group">
                                <input type="number" 
                                       name="{{ form.money_input.name }}"
                                       id="{{ form.money_input.id_for_label }}"
                                       class="form-control form-control-lg {% if form.money_input.errors %}is-invalid{% endif %}"
                                       value="{{ form.money_input.value|default:'' }}"
                                       step="0.01"
                                       min="0"
                                       placeholder="0.00">
                                <span class="input-group-text">‚ÇΩ</span>
                                {% if form.money_input.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.money_input.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- –ë–ª–æ–∫ —Å–¥–∞—á–∏ (–¥–ª—è –ø–æ–∫—É–ø–∫–∏) -->
                        <div class="card bg-success text-white mb-4" id="changeBlock" style="display: none;">
                            <div class="card-body">
                                <h5 class="mb-0">–°–¥–∞—á–∞: <span id="changeAmount">0.00</span> ‚ÇΩ</h5>
                            </div>
                        </div>

                        <!-- –ë–ª–æ–∫ –æ—à–∏–±–∫–∏ (–¥–ª—è –ø–æ–∫—É–ø–∫–∏) -->
                        <div class="alert alert-danger mb-4" id="errorBlock" style="display: none;">
                            <i class="bi bi-exclamation-triangle"></i> 
                            –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤! –¢—Ä–µ–±—É–µ—Ç—Å—è: <span id="requiredAmount">0.00</span> ‚ÇΩ
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∏ -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{% url 'britain_dashboard' %}" class="btn btn-secondary btn-lg me-md-2">
                                <i class="bi bi-x-circle"></i> –û—Ç–º–µ–Ω–∞
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                                <i class="bi bi-check-circle"></i> –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Å–¥–µ–ª–∫—É
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="col-md-4 mb-4">
            <!-- –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∫–æ—Ä–∞–±–ª–µ–π -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>–ö–æ—Ä–∞–±–ª—å</th>
                                    <th>–°–∫–æ—Ä–æ—Å—Ç—å</th>
                                    <th>–í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å</th>
                                    <th>–ü—É—à–∫–∏</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>–®—Ö—É–Ω–∞</td>
                                    <td>12 —É–∑–ª–æ–≤</td>
                                    <td>100 —Ç</td>
                                    <td>8</td>
                                </tr>
                                <tr>
                                    <td>–ë—Ä–∏–≥</td>
                                    <td>10 —É–∑–ª–æ–≤</td>
                                    <td>200 —Ç</td>
                                    <td>16</td>
                                </tr>
                                <tr>
                                    <td>–§—Ä–µ–≥–∞—Ç</td>
                                    <td>11 —É–∑–ª–æ–≤</td>
                                    <td>300 —Ç</td>
                                    <td>32</td>
                                </tr>
                                <tr>
                                    <td>–õ–∏–Ω–∫–æ—Ä</td>
                                    <td>8 —É–∑–ª–æ–≤</td>
                                    <td>500 —Ç</td>
                                    <td>64</td>
                                </tr>
                                <tr>
                                    <td>–ü–∞—Ä–æ–≤–æ–π —Ñ—Ä–µ–≥–∞—Ç</td>
                                    <td>14 —É–∑–ª–æ–≤</td>
                                    <td>400 —Ç</td>
                                    <td>40</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–¥–µ–ª–∫–∏ -->
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="bi bi-clock-history"></i> –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–¥–µ–ª–∫–∏</h5>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        {% for deal in recent_ship_deals|slice:":5" %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong>{{ deal.ship }}</strong>
                                    <span class="badge {% if deal.type == 'buy' %}bg-success{% else %}bg-warning{% endif %}">
                                        {{ deal.type }}
                                    </span>
                                </div>
                                <div>
                                    {{ deal.amount }} ‚ÇΩ
                                </div>
                            </div>
                            <small class="text-muted">–ò–≥—Ä–æ–∫ #{{ deal.player_id }} ‚Ä¢ {{ deal.timestamp|time:"H:i" }}</small>
                        </div>
                        {% empty %}
                        <div class="text-center text-muted py-3">
                            –ù–µ—Ç —Å–¥–µ–ª–æ–∫
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // –≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã
    const shipInput = document.getElementById('{{ form.ship.id_for_label }}');
    const dealTypeRadios = document.querySelectorAll('input[name="{{ form.deal_type.name }}"]');
    const moneyInput = document.getElementById('{{ form.money_input.id_for_label }}');
    const submitBtn = document.getElementById('submitBtn');
    const shipPriceSpan = document.getElementById('shipPrice');
    const totalPriceSpan = document.getElementById('totalPrice');
    const changeBlock = document.getElementById('changeBlock');
    const changeAmount = document.getElementById('changeAmount');
    const errorBlock = document.getElementById('errorBlock');
    const requiredAmount = document.getElementById('requiredAmount');
    const moneyInputBlock = document.getElementById('moneyInputBlock');
    const sellInfo = document.getElementById('sellInfo');
    
    // –¶–µ–Ω—ã –∫–æ—Ä–∞–±–ª–µ–π
    const shipPrices = {
        'schooner': 500,
        'brig': 1000,
        'frigate': 2000,
        'battleship': 5000,
        'steam_frigate': 8000
    };
    
    // –í—ã–±–æ—Ä –∫–æ—Ä–∞–±–ª—è
    window.selectShip = function(ship) {
        // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
        document.querySelectorAll('.ship-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É
        document.querySelector(`[data-ship="${ship}"]`).classList.add('selected');
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ
        shipInput.value = ship;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—É
        updatePrice();
    };
    
    // –í—ã–±–æ—Ä —Ç–∏–ø–∞ —Å–¥–µ–ª–∫–∏
    window.selectDealType = function(type) {
        // –ù–∞—Ö–æ–¥–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Ä–∞–¥–∏–æ-—ç–ª–µ–º–µ–Ω—Ç –∏ –æ—Ç–º–µ—á–∞–µ–º –µ–≥–æ
        const radio = document.querySelector(`input[name="{{ form.deal_type.name }}"][value="${type}"]`);
        if (radio) {
            radio.checked = true;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ –∫–Ω–æ–ø–æ–∫
        document.querySelectorAll('.deal-type-btn').forEach((btn, index) => {
            if ((type === 'buy' && index === 0) || (type === 'sell' && index === 1)) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Å–¥–µ–ª–∫–∏
        updateDealTypeUI();
        updatePrice();
    };
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Å–¥–µ–ª–∫–∏
    function updateDealTypeUI() {
        const isBuy = document.querySelector('input[name="{{ form.deal_type.name }}"]:checked')?.value === 'buy';
        
        if (isBuy) {
            moneyInputBlock.style.display = 'block';
            moneyInput.required = true;
            sellInfo.style.display = 'none';
            checkFunds();
        } else {
            moneyInputBlock.style.display = 'none';
            moneyInput.required = false;
            sellInfo.style.display = 'block';
            changeBlock.style.display = 'none';
            errorBlock.style.display = 'none';
            submitBtn.disabled = false;
        }
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω—ã
    function updatePrice() {
        const ship = shipInput.value;
        const isBuy = document.querySelector('input[name="{{ form.deal_type.name }}"]:checked')?.value === 'buy';
        
        if (ship && shipPrices[ship]) {
            const basePrice = shipPrices[ship];
            const finalPrice = isBuy ? basePrice : basePrice * 0.5;
            
            shipPriceSpan.textContent = basePrice;
            totalPriceSpan.textContent = finalPrice.toFixed(2);
            
            if (!isBuy) {
                // –î–ª—è –ø—Ä–æ–¥–∞–∂–∏ —Å—Ä–∞–∑—É –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
                submitBtn.disabled = false;
            }
        } else {
            shipPriceSpan.textContent = '0';
            totalPriceSpan.textContent = '0';
        }
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç–∏ —Å—Ä–µ–¥—Å—Ç–≤ (–¥–ª—è –ø–æ–∫—É–ø–∫–∏)
    function checkFunds() {
        const ship = shipInput.value;
        const money = parseFloat(moneyInput.value) || 0;
        
        if (ship && shipPrices[ship]) {
            const total = shipPrices[ship];
            
            if (money >= total) {
                const change = money - total;
                changeAmount.textContent = change.toFixed(2);
                changeBlock.style.display = 'block';
                errorBlock.style.display = 'none';
                submitBtn.disabled = false;
            } else {
                changeBlock.style.display = 'none';
                errorBlock.style.display = 'block';
                requiredAmount.textContent = total.toFixed(2);
                submitBtn.disabled = true;
            }
        }
    }
    
    // –°–æ–±—ã—Ç–∏—è
    if (moneyInput) {
        moneyInput.addEventListener('input', function() {
            if (document.querySelector('input[name="{{ form.deal_type.name }}"]:checked')?.value === 'buy') {
                checkFunds();
            }
        });
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    if (shipInput.value) {
        selectShip(shipInput.value);
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—ã–±—Ä–∞–Ω –ª–∏ —Ç–∏–ø —Å–¥–µ–ª–∫–∏
    const selectedDealType = document.querySelector('input[name="{{ form.deal_type.name }}"]:checked');
    if (selectedDealType) {
        selectDealType(selectedDealType.value);
    } else {
        // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã–±–∏—Ä–∞–µ–º –ø–æ–∫—É–ø–∫—É
        selectDealType('buy');
    }
});
</script>
{% endblock %}