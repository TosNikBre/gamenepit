{% extends 'base.html' %}

{% block title %}–í—ã–¥–∞—á–∞ –∫—Ä–µ–¥–∏—Ç–∞ - –í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è{% endblock %}

{% block extra_css %}
<style>
    .calculator-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .payment-schedule {
        max-height: 300px;
        overflow-y: auto;
    }
    .payment-item {
        transition: all 0.3s;
    }
    .payment-item:hover {
        background-color: #f8f9fa;
        transform: translateX(5px);
    }
    .interest-badge {
        font-size: 1.2rem;
        padding: 10px;
        border-radius: 10px;
        background: rgba(255,255,255,0.2);
    }
    .summary-card {
        border-left: 4px solid #28a745;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="bi bi-bank"></i> –í—ã–¥–∞—á–∞ –∫—Ä–µ–¥–∏—Ç–∞</h2>
            <div>
                <span class="badge bg-primary badge-custom me-2">
                    <i class="bi bi-person"></i> {{ session.username|default:'–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä' }}
                </span>
                <a href="{% url 'britain_credits' %}" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> –ö –∫—Ä–µ–¥–∏—Ç–∞–º
                </a>
            </div>
        </div>
        <p class="text-muted">–ë–∞–Ω–∫ –í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏–∏ - –∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–∏–µ –ø–æ–¥ –∑–∞–ª–æ–≥</p>
    </div>

    <div class="row">
        <!-- –§–æ—Ä–º–∞ –≤—ã–¥–∞—á–∏ –∫—Ä–µ–¥–∏—Ç–∞ -->
        <div class="col-md-7 mb-4">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-plus-circle"></i> –ù–æ–≤—ã–π –∫—Ä–µ–¥–∏—Ç</h5>
                </div>
                <div class="card-body">
                    <form method="post" id="creditIssueForm" novalidate>
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {% for error in form.non_field_errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}

                        <!-- –ù–æ–º–µ—Ä –∏–≥—Ä–æ–∫–∞ -->
                        <div class="mb-4">
                            <label for="{{ form.player_id.id_for_label }}" class="form-label fw-bold">
                                {{ form.player_id.label }} <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">#</span>
                                <input type="text" 
                                       name="{{ form.player_id.name }}"
                                       id="{{ form.player_id.id_for_label }}"
                                       class="form-control form-control-lg {% if form.player_id.errors %}is-invalid{% endif %}"
                                       value="{{ form.player_id.value|default:'' }}"
                                       placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∏–≥—Ä–æ–∫–∞"
                                       required>
                                <button class="btn btn-outline-secondary" type="button" id="checkPlayerBtn">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                            {% if form.player_id.errors %}
                                <div class="invalid-feedback">
                                    {{ form.player_id.errors.0 }}
                                </div>
                            {% endif %}
                            <div class="form-text" id="playerInfo"></div>
                        </div>

                        <!-- –°—É–º–º–∞ –∫—Ä–µ–¥–∏—Ç–∞ -->
                        <div class="mb-4">
                            <label for="{{ form.credit_amount.id_for_label }}" class="form-label fw-bold">
                                {{ form.credit_amount.label }} <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <input type="number" 
                                       name="{{ form.credit_amount.name }}"
                                       id="{{ form.credit_amount.id_for_label }}"
                                       class="form-control form-control-lg {% if form.credit_amount.errors %}is-invalid{% endif %}"
                                       value="{{ form.credit_amount.value|default:'' }}"
                                       step="0.01"
                                       min="100"
                                       placeholder="0.00"
                                       required>
                                <span class="input-group-text">‚ÇΩ</span>
                                {% if form.credit_amount.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.credit_amount.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="form-text">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –∫—Ä–µ–¥–∏—Ç–∞: 100 ‚ÇΩ</div>
                        </div>

                        <!-- –°—Ä–æ–∫ –∫—Ä–µ–¥–∏—Ç–∞ -->
                        <div class="mb-4">
                            <label for="{{ form.term.id_for_label }}" class="form-label fw-bold">
                                {{ form.term.label }} <span class="text-danger">*</span>
                            </label>
                            <select name="{{ form.term.name }}"
                                    id="{{ form.term.id_for_label }}"
                                    class="form-control form-control-lg {% if form.term.errors %}is-invalid{% endif %}"
                                    required>
                                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫ --</option>
                                {% for value, label in form.fields.term.choices %}
                                    <option value="{{ value }}" 
                                            {% if form.term.value == value %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                {% endfor %}
                            </select>
                            {% if form.term.errors %}
                                <div class="invalid-feedback">
                                    {{ form.term.errors.0 }}
                                </div>
                            {% endif %}
                        </div>

                        <!-- –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∫—Ä–µ–¥–∏—Ç–∞ -->
                        <div class="calculator-card mb-4">
                            <h5 class="mb-3">üìä –†–∞—Å—á–µ—Ç –∫—Ä–µ–¥–∏—Ç–∞</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <small>–°—É–º–º–∞ –∫—Ä–µ–¥–∏—Ç–∞:</small>
                                    <h4 id="calcAmount">0 ‚ÇΩ</h4>
                                </div>
                                <div class="col-md-6">
                                    <small>–ü—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞:</small>
                                    <h4>50% <span class="interest-badge">–≥–æ–¥–æ–≤—ã—Ö</span></h4>
                                </div>
                            </div>
                            <hr class="bg-white">
                            <div class="row">
                                <div class="col-md-6">
                                    <small>–ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç–µ–∂:</small>
                                    <h3 id="monthlyPayment">0 ‚ÇΩ</h3>
                                </div>
                                <div class="col-md-6">
                                    <small>–û–±—â–∞—è —Å—É–º–º–∞ –∫ –≤—ã–ø–ª–∞—Ç–µ:</small>
                                    <h3 id="totalPayment">0 ‚ÇΩ</h3>
                                </div>
                            </div>
                        </div>

                        <!-- –ì—Ä–∞—Ñ–∏–∫ –ø–ª–∞—Ç–µ–∂–µ–π -->
                        <div class="card mb-4">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0"><i class="bi bi-calendar-check"></i> –ì—Ä–∞—Ñ–∏–∫ –ø–ª–∞—Ç–µ–∂–µ–π</h5>
                            </div>
                            <div class="card-body payment-schedule">
                                <table class="table table-sm" id="paymentSchedule">
                                    <thead>
                                        <tr>
                                            <th>–ú–µ—Å—è—Ü</th>
                                            <th>–ü–ª–∞—Ç–µ–∂</th>
                                            <th>–û—Å—Ç–∞—Ç–æ–∫ –¥–æ–ª–≥–∞</th>
                                        </tr>
                                    </thead>
                                    <tbody id="scheduleBody">
                                        <tr>
                                            <td colspan="3" class="text-center text-muted">
                                                –í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ -->
                        <div class="card summary-card mb-4">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <small>–ò–≥—Ä–æ–∫:</small>
                                        <h5 id="summaryPlayer">‚Äî</h5>
                                    </div>
                                    <div class="col-md-6">
                                        <small>–°—É–º–º–∞ –∫—Ä–µ–¥–∏—Ç–∞:</small>
                                        <h5 id="summaryAmount">0 ‚ÇΩ</h5>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-md-6">
                                        <small>–°—Ä–æ–∫:</small>
                                        <h5 id="summaryTerm">‚Äî</h5>
                                    </div>
                                    <div class="col-md-6">
                                        <small>–ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç–µ–∂:</small>
                                        <h5 id="summaryMonthly">0 ‚ÇΩ</h5>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∏ -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{% url 'britain_credits' %}" class="btn btn-secondary btn-lg me-md-2">
                                <i class="bi bi-x-circle"></i> –û—Ç–º–µ–Ω–∞
                            </a>
                            <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
                                <i class="bi bi-check-circle"></i> –í—ã–¥–∞—Ç—å –∫—Ä–µ–¥–∏—Ç
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="col-md-5 mb-4">
            <!-- –£—Å–ª–æ–≤–∏—è –∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–∏—è -->
            <div class="card mb-4">
                <div class="card-header bg-warning">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> –£—Å–ª–æ–≤–∏—è –∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–∏—è</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li class="mb-3">
                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                            <strong>–ü—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞:</strong> 50% –æ—Ç —Å—É–º–º—ã
                        </li>
                        <li class="mb-3">
                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                            <strong>–°—Ä–æ–∫:</strong> –æ—Ç 2 –¥–æ 6 –º–µ—Å—è—Ü–µ–≤
                        </li>
                        <li class="mb-3">
                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                            <strong>–§–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á–µ—Ç–∞:</strong> (–°—É–º–º–∞ / –°—Ä–æ–∫) √ó 1.5
                        </li>
                        <li class="mb-3">
                            <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>
                            <strong>–ü—Ä–æ—Å—Ä–æ—á–∫–∞ –ø–ª–∞—Ç–µ–∂–∞:</strong> –±–æ–ª–µ–µ 10 –º–∏–Ω—É—Ç
                        </li>
                    </ul>
                </div>
            </div>

            <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ –∫—Ä–µ–¥–∏—Ç—ã –∏–≥—Ä–æ–∫–∞ -->
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="bi bi-credit-card"></i> –ê–∫—Ç–∏–≤–Ω—ã–µ –∫—Ä–µ–¥–∏—Ç—ã –∏–≥—Ä–æ–∫–∞</h5>
                </div>
                <div class="card-body" id="playerCredits">
                    <p class="text-muted text-center mb-0">
                        –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∏–≥—Ä–æ–∫–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                    </p>
                </div>
            </div>

            <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –≤—ã–¥–∞–Ω–Ω—ã–µ –∫—Ä–µ–¥–∏—Ç—ã -->
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="bi bi-clock-history"></i> –ü–æ—Å–ª–µ–¥–Ω–∏–µ –≤—ã–¥–∞–Ω–Ω—ã–µ –∫—Ä–µ–¥–∏—Ç—ã</h5>
                </div>
                <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                    {% for credit in recent_credits|slice:":10" %}
                    <div class="border-bottom mb-2 pb-2">
                        <div class="d-flex justify-content-between">
                            <span><strong>#{{ credit.player_id }}</strong></span>
                            <span class="badge bg-primary">{{ credit.amount }} ‚ÇΩ</span>
                        </div>
                        <small class="text-muted">
                            –°—Ä–æ–∫: {{ credit.term }} –º–µ—Å ‚Ä¢ {{ credit.timestamp|date:"d.m.Y H:i" }}
                        </small>
                    </div>
                    {% empty %}
                    <p class="text-muted text-center mb-0">–ù–µ—Ç –≤—ã–¥–∞–Ω–Ω—ã—Ö –∫—Ä–µ–¥–∏—Ç–æ–≤</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // –≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã
    const playerInput = document.getElementById('{{ form.player_id.id_for_label }}');
    const amountInput = document.getElementById('{{ form.credit_amount.id_for_label }}');
    const termSelect = document.getElementById('{{ form.term.id_for_label }}');
    const submitBtn = document.getElementById('submitBtn');
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    const calcAmount = document.getElementById('calcAmount');
    const monthlyPayment = document.getElementById('monthlyPayment');
    const totalPayment = document.getElementById('totalPayment');
    const scheduleBody = document.getElementById('scheduleBody');
    const summaryPlayer = document.getElementById('summaryPlayer');
    const summaryAmount = document.getElementById('summaryAmount');
    const summaryTerm = document.getElementById('summaryTerm');
    const summaryMonthly = document.getElementById('summaryMonthly');
    const playerInfo = document.getElementById('playerInfo');
    const playerCredits = document.getElementById('playerCredits');

    // –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ –µ–∂–µ–º–µ—Å—è—á–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
    function calculateMonthly(amount, term) {
        // (–°—É–º–º–∞ / –°—Ä–æ–∫) * 1.5
        return (amount / term) * 1.5;
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
    function updateCalculator() {
        const amount = parseFloat(amountInput.value) || 0;
        const term = parseInt(termSelect.value) || 0;
        
        if (amount > 0 && term > 0) {
            const monthly = calculateMonthly(amount, term);
            const total = monthly * term;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            calcAmount.textContent = amount.toFixed(2) + ' ‚ÇΩ';
            monthlyPayment.textContent = monthly.toFixed(2) + ' ‚ÇΩ';
            totalPayment.textContent = total.toFixed(2) + ' ‚ÇΩ';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –ø–ª–∞—Ç–µ–∂–µ–π
            updatePaymentSchedule(amount, term, monthly);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤–æ–¥–∫—É
            summaryAmount.textContent = amount.toFixed(2) + ' ‚ÇΩ';
            summaryTerm.textContent = term + ' –º–µ—Å';
            summaryMonthly.textContent = monthly.toFixed(2) + ' ‚ÇΩ';
        } else {
            calcAmount.textContent = '0 ‚ÇΩ';
            monthlyPayment.textContent = '0 ‚ÇΩ';
            totalPayment.textContent = '0 ‚ÇΩ';
            scheduleBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞</td></tr>';
            summaryAmount.textContent = '0 ‚ÇΩ';
            summaryTerm.textContent = '‚Äî';
            summaryMonthly.textContent = '0 ‚ÇΩ';
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π
    function updatePaymentSchedule(amount, term, monthly) {
        let remaining = amount;
        let scheduleHtml = '';
        
        for (let i = 1; i <= term; i++) {
            remaining -= monthly;
            if (remaining < 0) remaining = 0;
            
            scheduleHtml += `
                <tr class="payment-item">
                    <td>${i}</td>
                    <td>${monthly.toFixed(2)} ‚ÇΩ</td>
                    <td>${remaining.toFixed(2)} ‚ÇΩ</td>
                </tr>
            `;
        }
        
        scheduleBody.innerHTML = scheduleHtml;
    }

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–≥—Ä–æ–∫–∞
    function checkPlayer() {
        const playerId = playerInput.value.trim();
        
        if (playerId) {
            summaryPlayer.textContent = '#' + playerId;
            playerInfo.innerHTML = `<span class="text-success">‚úì –ò–≥—Ä–æ–∫ #${playerId} –Ω–∞–π–¥–µ–Ω</span>`;
            
            // –ó–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å AJAX –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫—Ä–µ–¥–∏—Ç–æ–≤ –∏–≥—Ä–æ–∫–∞
            playerCredits.innerHTML = `
                <div class="alert alert-info">
                    <small>–ê–∫—Ç–∏–≤–Ω—ã—Ö –∫—Ä–µ–¥–∏—Ç–æ–≤: 0</small><br>
                    <small>–û–±—â–∞—è –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å: 0 ‚ÇΩ</small>
                </div>
            `;
        } else {
            summaryPlayer.textContent = '‚Äî';
            playerInfo.innerHTML = '';
            playerCredits.innerHTML = '<p class="text-muted text-center mb-0">–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∏–≥—Ä–æ–∫–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</p>';
        }
    }

    // –°–æ–±—ã—Ç–∏—è
    playerInput.addEventListener('blur', checkPlayer);
    amountInput.addEventListener('input', updateCalculator);
    termSelect.addEventListener('change', updateCalculator);
    
    document.getElementById('checkPlayerBtn').addEventListener('click', checkPlayer);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    updateCalculator();
    if (playerInput.value) {
        checkPlayer();
    }
});
</script>
{% endblock %}